<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Estaciones — Precipitación</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root {
      --border:#e5e7eb;
      --muted:#6b7280;
    }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#111827; }
    #app { display: grid; grid-template-columns: 1.2fr 0.8fr; height: 100vh; }
    #map { width: 100%; height: 100%; }
    #panel { padding: 16px; overflow: auto; border-left: 1px solid var(--border); }
    h1 { font-size: 18px; margin: 0 0 8px; }
    .muted { color: var(--muted); font-size: 12px; }
    .meta { margin: 8px 0 12px; line-height: 1.4; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; margin-right:6px; font-size:12px; }
    .src { font-size:12px; margin-top: 8px; }
    .src a { color:#2563eb; text-decoration:none; }
    .card { border:1px solid var(--border); border-radius:12px; padding:12px; margin-top:12px; }
    .card h2 { font-size:14px; margin:0 0 6px; }
    canvas { max-width: 100%; }
    @media (max-width: 900px) {
      #app { grid-template-columns: 1fr; grid-template-rows: 52vh 48vh; }
      #panel { border-left: none; border-top: 1px solid var(--border); }
    }
  </style>
</head>
<body>
<div id="app">
  <div id="map"></div>
  <div id="panel">
    <h1>Estaciones — resumen mensual</h1>
    <div class="muted">Haz clic en una estación para ver sus promedios mensuales.</div>
    <div id="est-meta" class="meta muted">Sin estación seleccionada.</div>
    <div class="src">Origen de datos: <a href="https://www.cr2.cl/datos-de-precipitacion/" target="_blank" rel="noopener">CR2 — Datos de precipitación</a></div>

    <div class="card">
      <h2>Precipitación media mensual (mm)</h2>
      <canvas id="chart-prcp" height="200"></canvas>
    </div>
    <div class="card">
      <h2>Promedio mensual de <em>días con lluvia</em> (días)</h2>
      <canvas id="chart-dias" height="200"></canvas>
    </div>
    <div class="card">
      <h2>Promedio mensual de <em>eventos de lluvia</em> (eventos)</h2>
      <canvas id="chart-eventos" height="200"></canvas>
    </div>
  </div>
</div>

<!-- Datos embebidos -->
<script id="stations-geojson" type="application/json">
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -71.1044,
          -29.8369
        ]
      },
      "properties": {
        "Codigo": "4334001",
        "Nombre": "Fundo San Antonio",
        "Elev_m": 260,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "R. Elqui Bajo"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.3847,
          -29.8478
        ]
      },
      "properties": {
        "Codigo": "4306002",
        "Nombre": "Huanta",
        "Elev_m": 1240,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Turbio"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.5328,
          -29.9458
        ]
      },
      "properties": {
        "Codigo": "4308001",
        "Nombre": "Rio Turbio En Varillar",
        "Elev_m": 890,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Turbio"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.28,
          -29.9519
        ]
      },
      "properties": {
        "Codigo": "4331004",
        "Nombre": "Molino Yaco",
        "Elev_m": 1550,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "R. Elqui Bajo"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.0928,
          -29.9711
        ]
      },
      "properties": {
        "Codigo": "4302001",
        "Nombre": "Rio Toro Antes Junta Rio La Laguna",
        "Elev_m": 2165,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Turbio"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.0944,
          -29.9769
        ]
      },
      "properties": {
        "Codigo": "4302014",
        "Nombre": "Juntas",
        "Elev_m": 2150,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Turbio"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.5617,
          -29.9772
        ]
      },
      "properties": {
        "Codigo": "4308003",
        "Nombre": "Rivadavia",
        "Elev_m": 820,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Turbio"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.5525,
          -29.9781
        ]
      },
      "properties": {
        "Codigo": "4314002",
        "Nombre": "Rio Claro En Rivadavia",
        "Elev_m": 820,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Claro"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.5867,
          -29.9953
        ]
      },
      "properties": {
        "Codigo": "4320001",
        "Nombre": "Rio Elqui En Algarrobal",
        "Elev_m": 760,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "R. Elqui Medio"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.8556,
          -29.9964
        ]
      },
      "properties": {
        "Codigo": "4321001",
        "Nombre": "Puclaro Embalse",
        "Elev_m": 460,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "R. Elqui Medio"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.7167,
          -30.0567
        ]
      },
      "properties": {
        "Codigo": "4320003",
        "Nombre": "Vicua (Inia)",
        "Elev_m": 730,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "R. Elqui Medio"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.4939,
          -30.0894
        ]
      },
      "properties": {
        "Codigo": "4314003",
        "Nombre": "Monte Grande",
        "Elev_m": 1120,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Claro"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.4933,
          -30.1217
        ]
      },
      "properties": {
        "Codigo": "4311003",
        "Nombre": "Pisco Elqui Dmc",
        "Elev_m": 1250,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Claro"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.4047,
          -30.1414
        ]
      },
      "properties": {
        "Codigo": "4313003",
        "Nombre": "Cochiguaz",
        "Elev_m": 1560,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Claro"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.4983,
          -30.1472
        ]
      },
      "properties": {
        "Codigo": "4311004",
        "Nombre": "Los Nichos",
        "Elev_m": 1330,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Claro"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.4819,
          -30.1939
        ]
      },
      "properties": {
        "Codigo": "4311005",
        "Nombre": "La Ortiga",
        "Elev_m": 1560,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Claro"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.0422,
          -30.2033
        ]
      },
      "properties": {
        "Codigo": "4301005",
        "Nombre": "La Laguna Embalse",
        "Elev_m": 3160,
        "Cuenca": "Rio Elqui",
        "Subcuenca": "Rio Turbio"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          -70.6961,
          -30.2867
        ]
      },
      "properties": {
        "Codigo": "4502005",
        "Nombre": "Hurtado",
        "Elev_m": 1100,
        "Cuenca": "Rio Limari",
        "Subcuenca": "Rio Hurtado"
      }
    }
  ]
}
</script>
<script id="series-prcp" type="application/json">
{"4301005": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [6.304, 4.236, 1.341, 1.531, 3.621, 4.42, 7.562, 22.696, 34.031, 41.062, 24.889, 5.935]}, "4302001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 3.4, 0.683, 0.1, 0.12, 0.35, 3.6, 23.475, 14.65, 11.15, 10.675, 0.775]}, "4302014": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.904, 1.089, 0.712, 0.835, 1.326, 3.446, 4.131, 16.538, 26.781, 23.267, 11.635, 5.529]}, "4306002": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.283, 1.587, 0.373, 0.079, 0.44, 2.9, 1.955, 11.38, 17.165, 12.197, 11.09, 1.903]}, "4308001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 5.675, 0.75, 1.38, 0.0, 16.643, 22.157, 1.525, 0.8, 14.736, 8.425, 5.302]}, "4308003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.042, 1.89, 0.289, 0.506, 0.218, 1.751, 2.96, 12.493, 23.669, 28.871, 17.579, 5.385]}, "4311003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 1.346, 0.246, 0.0, 0.138, 2.19, 4.488, 12.876, 26.571, 36.227, 15.437, 2.205]}, "4311004": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.138, 1.54, 0.28, 0.0, 0.325, 2.654, 6.063, 15.212, 30.622, 45.45, 18.331, 4.28]}, "4311005": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.085, 2.275, 0.188, 0.064, 0.305, 2.915, 4.28, 19.585, 39.08, 44.78, 21.0, 4.412]}, "4313003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.803, 0.933, 0.19, 0.0, 4.317, 3.658, 18.6, 29.73, 17.257, 17.557, 3.347]}, "4314002": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.033, 15.4, 0.0, 0.42, 0.0, 0.0, 40.852, 33.525, 12.867, 23.325, 6.433, 6.367]}, "4314003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 1.017, 0.217, 0.0, 0.083, 1.613, 1.817, 8.575, 20.03, 25.169, 11.056, 2.729]}, "4320001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.189, 5.178, 0.044, 0.489, 0.0, 7.511, 2.622, 20.444, 33.944, 13.533, 13.567, 3.778]}, "4320003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.071, 2.55, 0.325, 0.057, 0.02, 1.918, 3.414, 13.767, 22.39, 27.214, 16.308, 4.859]}, "4321001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 4.4, 1.9, 0.0, 0.0, 0.0, 1.833, 5.625, 20.0, 60.75, 21.84, 10.6]}, "4331004": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [1.286, 5.812, 0.0, 0.0, 1.429, 0.429, 2.714, 1.643, 11.429, 15.086, 17.771, 3.938]}, "4334001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8"], "values": [0.0, 8.75, 0.0, 0.0, 0.0, 0.0, 0.0, 2.0, 35.4, 20.0, 0.0]}, "4502005": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.233, 2.966, 1.067, 0.5, 1.667, 1.174, 4.905, 17.764, 34.218, 34.607, 22.058, 5.816]}}
</script>
<script id="series-dias" type="application/json">
{"4301005": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.585, 0.42, 0.148, 0.284, 0.451, 0.512, 0.667, 1.309, 1.889, 1.938, 1.321, 0.556]}, "4302001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.049, 0.012, 0.012, 0.012, 0.024, 0.062, 0.148, 0.123, 0.062, 0.123, 0.025]}, "4302014": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.085, 0.099, 0.037, 0.074, 0.085, 0.171, 0.222, 0.556, 0.753, 0.605, 0.346, 0.173]}, "4306002": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.037, 0.136, 0.025, 0.025, 0.037, 0.085, 0.259, 0.395, 0.519, 0.667, 0.407, 0.173]}, "4308001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.012, 0.049, 0.0, 0.037, 0.012, 0.012, 0.012, 0.012, 0.012, 0.062, 0.086, 0.012]}, "4308003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.024, 0.272, 0.099, 0.049, 0.061, 0.244, 0.432, 1.062, 1.741, 1.864, 1.568, 0.679]}, "4311003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.136, 0.025, 0.0, 0.049, 0.11, 0.284, 0.654, 0.84, 1.074, 0.654, 0.16]}, "4311004": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.012, 0.136, 0.025, 0.0, 0.049, 0.134, 0.235, 0.63, 0.864, 1.086, 0.716, 0.21]}, "4311005": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.024, 0.148, 0.012, 0.012, 0.024, 0.146, 0.272, 0.728, 0.951, 1.123, 0.827, 0.222]}, "4313003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.049, 0.049, 0.025, 0.0, 0.171, 0.272, 0.617, 0.741, 0.617, 0.556, 0.185]}, "4314002": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.049, 0.0, 0.025, 0.0, 0.0, 0.037, 0.086, 0.049, 0.025, 0.025, 0.025]}, "4314003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.136, 0.037, 0.0, 0.024, 0.134, 0.259, 0.704, 1.21, 1.247, 0.802, 0.296]}, "4320001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.037, 0.074, 0.012, 0.025, 0.0, 0.049, 0.086, 0.185, 0.247, 0.148, 0.21, 0.049]}, "4320003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.024, 0.222, 0.049, 0.025, 0.024, 0.159, 0.259, 0.704, 0.951, 1.198, 1.037, 0.444]}, "4321001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.012, 0.012, 0.0, 0.0, 0.0, 0.025, 0.025, 0.099, 0.111, 0.136, 0.099]}, "4331004": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.024, 0.074, 0.0, 0.0, 0.049, 0.037, 0.025, 0.037, 0.136, 0.173, 0.185, 0.062]}, "4334001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.012, 0.0, 0.0, 0.0, 0.0, 0.0, 0.012, 0.025, 0.012, 0.0, 0.0]}, "4502005": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.049, 0.321, 0.16, 0.062, 0.085, 0.183, 0.469, 1.173, 1.926, 1.914, 1.444, 0.63]}}
</script>
<script id="series-eventos" type="application/json">
{"4301005": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.39, 0.309, 0.136, 0.21, 0.28, 0.39, 0.481, 0.852, 1.222, 1.173, 0.778, 0.432]}, "4302001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.025, 0.012, 0.012, 0.012, 0.024, 0.037, 0.099, 0.025, 0.037, 0.049, 0.012]}, "4302014": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.049, 0.074, 0.037, 0.037, 0.061, 0.11, 0.16, 0.358, 0.457, 0.37, 0.222, 0.123]}, "4306002": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.024, 0.099, 0.025, 0.025, 0.012, 0.061, 0.198, 0.309, 0.37, 0.481, 0.21, 0.123]}, "4308001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.012, 0.025, 0.0, 0.025, 0.012, 0.012, 0.012, 0.012, 0.012, 0.037, 0.037, 0.012]}, "4308003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.024, 0.247, 0.074, 0.049, 0.049, 0.207, 0.284, 0.765, 1.148, 1.198, 1.037, 0.494]}, "4311003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.099, 0.025, 0.0, 0.037, 0.073, 0.198, 0.494, 0.593, 0.679, 0.395, 0.136]}, "4311004": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.012, 0.111, 0.025, 0.0, 0.049, 0.085, 0.185, 0.494, 0.63, 0.728, 0.457, 0.148]}, "4311005": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.024, 0.123, 0.012, 0.012, 0.024, 0.11, 0.222, 0.519, 0.617, 0.704, 0.481, 0.173]}, "4313003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.049, 0.049, 0.012, 0.0, 0.122, 0.185, 0.42, 0.42, 0.481, 0.37, 0.16]}, "4314002": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.025, 0.0, 0.012, 0.0, 0.0, 0.037, 0.049, 0.037, 0.012, 0.012, 0.025]}, "4314003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.123, 0.037, 0.0, 0.024, 0.085, 0.173, 0.58, 0.864, 0.753, 0.444, 0.235]}, "4320001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.024, 0.049, 0.012, 0.012, 0.0, 0.024, 0.062, 0.123, 0.123, 0.099, 0.111, 0.049]}, "4320003": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.024, 0.185, 0.037, 0.025, 0.024, 0.122, 0.185, 0.494, 0.679, 0.765, 0.605, 0.346]}, "4321001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.012, 0.012, 0.0, 0.0, 0.0, 0.025, 0.025, 0.086, 0.074, 0.123, 0.037]}, "4331004": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.012, 0.037, 0.0, 0.0, 0.049, 0.037, 0.025, 0.037, 0.099, 0.099, 0.111, 0.049]}, "4334001": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.0, 0.012, 0.0, 0.0, 0.0, 0.0, 0.0, 0.012, 0.012, 0.012, 0.0, 0.0]}, "4502005": {"labels": ["1", "10", "11", "12", "2", "3", "4", "5", "6", "7", "8", "9"], "values": [0.049, 0.309, 0.136, 0.049, 0.073, 0.146, 0.37, 0.827, 1.284, 1.309, 1.049, 0.519]}}
</script>

<!-- Librerías -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
const STATIONS = JSON.parse(document.getElementById("stations-geojson").textContent);
const PRCP = JSON.parse(document.getElementById("series-prcp").textContent);
const DIAS = JSON.parse(document.getElementById("series-dias").textContent);
const EVENTOS = JSON.parse(document.getElementById("series-eventos").textContent);
const MES_MAP = {"1": "Ene", "2": "Feb", "3": "Mar", "4": "Abr", "5": "May", "6": "Jun", "7": "Jul", "8": "Ago", "9": "Sep", "10": "Oct", "11": "Nov", "12": "Dic"};

function mapMes(labels) { return labels.map(l => MES_MAP[l] ?? l); }

const map = L.map('map').setView([-30.039872222222225, -70.49292777777777], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

L.geoJSON(STATIONS, {
  pointToLayer: (feat, latlng) => L.marker(latlng),
  onEachFeature: (feat, layer) => {
    const p = feat.properties || {}
    const title = p.Nombre || 'Estación';
    const cod = p.Codigo || '—';
    const elev = p.Elev_m != null ? `<span class="chip">${p.Elev_m} m</span>` : '';
    const cuenca = p.Cuenca ? `<span class="chip">${p.Cuenca}</span>` : '';
    const subc = p.Subcuenca ? `<span class="chip">${p.Subcuenca}</span>` : '';

    layer.bindTooltip(title);
    layer.on('click', () => selectStation(cod, title, elev, cuenca, subc));
  }
}).addTo(map);

let chartP, chartD, chartE;
function renderChart(el, labels, values, title, unit) {
  if (el.chart) el.chart.destroy();
  const ctx = el.getContext('2d');
  el.chart = new Chart(ctx, {
    type: 'bar',
    data: { labels: mapMes(labels), datasets: [{ label: unit, data: values }] },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, title: { display: true, text: unit } }
      },
      plugins: {
        title: { display: false },
        legend: { display: false },
        tooltip: {
          callbacks: { label: (ctx) => (ctx.parsed.y != null ? ctx.parsed.y.toLocaleString('es-CL') + ' ' + unit : '—') }
        }
      }
    }
  });
}

function selectStation(codigo, nombre, elev, cuenca, subc) {
  const meta = document.getElementById('est-meta');
  meta.classList.remove('muted');
  meta.innerHTML = `<b>${nombre}</b> <span class="muted">(${codigo})</span><div>${elev} ${cuenca} ${subc}</div>`;

  const pr = PRCP[codigo];
  const di = DIAS[codigo];
  const ev = EVENTOS[codigo];

  const elP = document.getElementById('chart-prcp');
  const elD = document.getElementById('chart-dias');
  const elE = document.getElementById('chart-eventos');

  if (pr) renderChart(elP, pr.labels, pr.values, 'Precipitación media mensual', 'mm');
  else renderChart(elP, [], [], 'Precipitación media mensual', 'mm');

  if (di) renderChart(elD, di.labels, di.values, 'Promedio mensual de días con lluvia', 'días');
  else renderChart(elD, [], [], 'Promedio mensual de días con lluvia', 'días');

  if (ev) renderChart(elE, ev.labels, ev.values, 'Promedio mensual de eventos de lluvia', 'eventos');
  else renderChart(elE, [], [], 'Promedio mensual de eventos de lluvia', 'eventos');
}
</script>
</body>
</html>
